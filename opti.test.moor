\\
\\ Optimizer tests
\\


: optimize!
	( :#params :xt )
	here | ." CODE at " .
	{
	regalloc-init :#params | if for ?^ over else _ then 
	:#params :xt optimize
	}
	(code) interpretation :xt does
	return
;


: fib		| if 0 1 >>> for >| + >< over _ then noop ;
: nup		>r _ r> ;
: lswap		( :c :d ) :c :d :c! :d! :c :d return ;
: -lswap	( :c :d ) :c :d :c! :d! :d :c return ;
: onep		| 1+ 1+ 1+ >< - ;
: cset		1 3333 c! ;
: for1		1 for | emit over ;
: for2		( :c ) 1 for :c emit over return ;
: fill		<<< for >|>| c! 1+ over _ _ ;			\ ( a n c -- )		Fill N bytes from address A with character C
: fill2		( :a :n :c ) :a :n for | :c >< c! 1+ over _ return ;

: opti-fib	1 ['] fib	optimize! ;
: opti-nup	2 ['] nup	optimize! ;
: opti-lswap	2 ['] lswap	optimize! ;
: opti--lswap	2 ['] -lswap	optimize! ;
: opti-onep	1 ['] onep	optimize! ;
: opti-cset	0 ['] cset	optimize! ;
: opti-fill	3 ['] fill	optimize! ;

: opti-for1	1 ['] for1	optimize! ;
: opti-for2	1 ['] for2	optimize! ;
: opti-fill2	3 ['] fill2	optimize! ; \\ TODO: not working -- and it's clear why, look at disassembly
: type-fill2	~Adr ~Number ~Number ['] fill2 typecheck ;

maze
: opti-MAZE	0 ['] MAZE	optimize! ;


:: zzz adr 100 allot
: qqq zzz 10 31 fill2 ;




