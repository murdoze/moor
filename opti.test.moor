\\
\\ Optimizer tests
\\


: optimize!
	( :#params :xt )
	here | ." CODE at " .
	{
	regalloc-init :#params | if for ?^ over else _ then 
	:#params :xt optimize
	}
	(code) interpretation :xt does
	return
;


: fib		| if 0 1 >>> for >| + >< over _ then ;
: nup		>r _ r> ;
: swap2		0 <<< <<< nup ;
: lswap		( :c :d ) :c :d :c! :d! :c :d return ;
: -lswap	( :c :d ) :c :d :c! :d! :d :c return ;
: onep		| 1+ 1+ 1+ >< - ;
: cset		1 3333 c! ;
: if1		1 2 - if 0 else 1 then ;
: if2		1 2 < if 0 else 1 then ;
: for1		3 for | uemit over _ cr ;
: for2		( :c ) 1 for :c emit over return ;
: fill		<<< for >|>| c! 1+ over _ _ ;
: fill2		( :a :n :c ) :a :n for | :c >< c! 1+ over _ return ;
: fill3		( :a :n :c ) :n for :c emit over return ;
: fill4		( :a :n :c ) :n if :c emit then return ;

: opti-fib	1 ['] fib	optimize! ;
: opti-nup	2 ['] nup	optimize! ;
: opti-swap2	2 ['] swap2	optimize! ;
: opti-lswap	2 ['] lswap	optimize! ;
: opti-lswap	2 ['] lswap	optimize! ;
: opti--lswap	2 ['] -lswap	optimize! ;
: opti-onep	1 ['] onep	optimize! ;
: opti-cset	0 ['] cset	optimize! ;
: opti-fill	3 ['] fill	optimize! ;

: opti-if1	0 ['] if1	optimize! ;
: opti-if2	0 ['] if2	optimize! ;
: opti-for1	1 ['] for1	optimize! ;
: opti-for2	1 ['] for2	optimize! ;
: opti-fill2	3 ['] fill2	optimize! ;
: opti-fill3	3 ['] fill3	optimize! ;
: opti-fill4	3 ['] fill4	optimize! ;

: type-fill2	~Adr ~Number ~Number ['] fill2 typecheck ;

maze
: opti-MAZE	0 ['] MAZE	optimize! ;


:: zzz adr 100 allot
: qqq zzz 10 31 fill2 ;




